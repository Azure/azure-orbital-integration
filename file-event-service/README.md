# File Event Service
FileEventService is an event driven tool that can listen for Event Grid or local file system events and action on those events. Current actions can download blob data, upload blob data, execute a script or send an event to Event Grid.

# Integration with aqua-processor
FileEventService runs as a systemd service on the aqua processor VM. It retrieves new contact data for RT-STPS to process. Once contact data is written to blob using the tcp-to-blob component, an Event Grid alert is sent and FileEventService receives that event via Service Bus and executes a script followed by uploading NASA tool outputs to blob. The current chain of events are as follows:

  1. Tcp-to-blob receives the blob data, writes that data to blob store, triggering a blob created event on Event Grid.
  2. FileEventService receives the Event Grid message via Service Bus and downloads the blob data to the users home directory under `~/blobdata`
  3. FileEventService watches the `~/blobdata` folder for new files, triggering a script to run NASA tools (RT-STPS and IPOPP). Once RT-STPS runs, the output PDS files are then copied to a staging folder `~/data-staging` for blob upload and the IPOPP landing zone folder `~/drl/data/dsm/ingest/` for IPOPP ingest. Once the files are palced in the IPOPP landing zone folder, `drl/tools/ingest_ipopp.sh` is executed.
  4. FileEventService watches for PDS files to be created in the staging folder `~/data-staging` and triggers a blob upload to write new files to the `pds` container.
  5. FileEventService watches for IPOPP output under the `~/drl/data/pub/gsfcdata/aqua/modis` folder and uploads those files to their respective folders under the `modis` container.

During deployment of the aqua-processor component, we leverage a predefined `file-event-service.template.json` file under `aqua-processor/deploy/file-event-service` and use envsubst to replace tokens in the template with the appropriate values. This file is then packaged up and sent to blob store where it will get downloaded and used by the VM deployment.

# File Event Service configuration
FileEventService supports receiving Event Grid messages via Service Bus. You can configure as many event listeners or event dispatchers as needed.

Event listeners are used for listening for Event Grid messages, while event dispatchers are used for producing and consuming events local to FileEventService, i.e. the LocalFileSystem dispatcher for producing a new event when a new file is created.

Actions are used for consuming events either received from Event Grid or by consuming events generated by an event dispatcher. You can have 1 to many actions for a given event.

# File Event Service options
```json
"environmentName": "string",
"eventListeners": [/* Array of event listener objects */],
"eventDispatchers": [/* Array of event dispatcher objects */]
```
|Property|Description|
|-|-|
|environmentName|Since you can run multiple instances of FileEventService, this is a unique name that would distinguish one FileEventService instance from another. This name is helpful for parsing logs.|
|eventListeners|A collection of `eventListeners` that Event Grid messages will be received from. [See Event Listeners](#event-listeners)|
|eventDispatchers|A collection of `eventDispatchers` that Event Grid messages will be received from. [See Event Dispatchers](#event-dispatchers)|

# Event listeners
Provides functionality to receive Event Grid messages by way of Service Bus, specifically Azure Storage Event Grid messages.

`Documentation:` [Azure Service Bus](https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview)

```json
{
  "type": "string",
  "name": "string",
  "connectionString": "string",
  "queueName": "string",
  "actions": [/* Array of action objects */],
  "allowedEventTypes": [/* Array of strings */]
}
```

|Property|Description|
|-|-|
|type|Specifies the event listener type, supported type `ServiceBus`|
|name|A unique name that would help distinguish one event listener from another. This name is helpful for parsing logs.|
|connectionString|The connection string used for authenticating with Service Bus.|
|queueName|The Service Bus queue name where messages are received.|
|actions|A collection of actions to execute when an event is received. [See Event Actions](#event-actions)|
|allowedEventTypes|A string collection of event types, i.e. Microsoft.Blob.Created. [See available event types](https://docs.microsoft.com/en-us/azure/event-grid/event-schema-blob-storage?tabs=event-grid-event-schema#available-event-types) for a complete list.|

# Event dispatchers
Provides functionality to produce local file system events.

`Documentation:` [Azure Service Bus](https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview)

```json
{
  "type": "string",
  "name": "string",
  "pathToWatch": "string",
  "includeSubDirectories": "bool",
  "filters": [/* Array of strings */],
  "actions": [/* Array of action objects */],
  "allowedEventTypes": [/* Array of strings */]
}
```

|Property|Description|
|-|-|
|type|Specifies the event listener type, supported type `ServiceBus`|
|name|A unique name that would help distinguish one event listener from another. This name is helpful for parsing logs.|
|pathToWatch|The path you want to watch for file events.|
|includeSubDirectories|Whether or not you want watching to be recursive.|
|filters|Filters to watch for specific file types, i.e. \*.log. For all files, use \*.\*|
|actions|A collection of actions to execute when an event is received. [See Event Actions](#event-actions)|
|allowedEventTypes|A string collection of event types, i.e. Local.FileSystem.Created. Available events will be `Local.FileSystem.Created`, `Local.FileSystem.Changed`, `Local.FileSystem.Renamed` and/or `Local.FileSystem.Deleted`. For more information, [See FileSystemWatcher](https://docs.microsoft.com/en-us/dotnet/api/system.io.filesystemwatcher?view=net-6.0)|

# Event actions
Provides the ability to execute an action or multiple actions for a given event. Each given action has a unique configuration and may only be supported with event listeners and or event dispatchers. Please see the following action compatability table for current available actions 

|Action Type|Supported with event listeners|Supported with event dispatchers|
|-|:-:|:-:|
|[BlobDownload](#blobdownload)|✅|❌|
|[BlobUpload](#blobupload)|❌|✅|
|[ExecuteScript](#executescript)|✅|✅|
|[SendEventGridEvent](#sendeventgridevent)|✅|✅|

## BlobDownload
Provides blob download functionality.

```json
{
  "type": "BlobDownload",
  "connectionString": "string",
  "localBlobDownloadPath": "string"
}
```

|Property|Description|
|-|-|
|type|Specifies the action type.|
|connectionString|The connection string used for authenticating with Azure storage.|
|localBlobDownloadPath|The local download path where blobs will be downloaded to.|

## BlobUpload
Provides blob upload functionality.

```json
{
  "type": "BlobUpload",
  "connectionString": "string",
  "containerName": "string",
  "filePath": "string"
}
```

|Property|Description|
|-|-|
|type|Specifies the action type.|
|connectionString|The connection string used for authenticating with Azure storage.|
|containerName|The container name where blobs will be uploaded.|
|filePath|The file path within a container where blobs will be uploaded.|

## ExecuteScript
Provides script execution functionality. When the script gets called, an environment variable named `FES_EVENT_GRID_EVENT` will be set for the scripts running context. Since we are working with Event Grid events, we use the same Event Grid schema. [See File Event Service Event Grid schema](#file-event-service-event-grid-schema)

```json
{
  "type": "ExecuteScript",
  "filename": "string",
  "workingDirectory": "string",
  "arguments": "string"
}
```
|Property|Description|
|-|-|
|type|Specifies the action type.|
|filename|The script filename. If the script lives elsewhere, the path can also be included.|
|workingDirectory|The working directory you intend the script to be run under.|
|arguments|Any runtime arguments you wish to pass into the script.|

## SendEventGridEvent
Provides the ability to send Event Grid events.

`Documentation:` [Azure Event Grid](https://docs.microsoft.com/en-us/dotnet/api/overview/azure/messaging.eventgrid-readme-pre)

```json
{
  "type": "SendEventGridEvent",
  "topicEndpoint": "string",
  "key": "string"
}
```

|Property|Description|
|-|-|
|type|Specifies the action type.|
|topicEndpoint|Event Grid topic endpoint.|
|key|The key used to authorize the client.|

# File Event Service Event Grid schema
This is the schema of the File Event Service's Event Grid event that is made available to the `ExecuteScript` action via the environment variable named `FES_EVENT_GRID_EVENT`. The root object consists of some higher level metadata.

```json
{
  "id": "string",
  "subject": "string",
  "data": {/* data object */},
  "eventType": "string",
  "dataVersion": "string",
  "eventTime": "UTC datetimeoffset as string",
}
```

|Property|Description|
|-|-|
|id|Identifier for the event.|
|subject|The path to the file that triggered the event.|
|eventType|The event type that triggered the event, i.e., *Local.FIleSystem.Created*|
|dataVersion|The version of the data object.|
|eventTime|The time the event was triggered.|

The data object consists of file metadata of the file that triggered the alert.
```json
"data": {
  "Name": "string",
  "OldName": "string",
  "OldFullPath": "string",
  "FileName": "string",
  "DirectoryName": "string",
  "FullFilePath": "string",
  "ContentLength": "long",
  "CorrelationId": "string",
  "PathToWatch": "string",
  "IncludeSubDirectories": "bool",
  "Filters": [
    "strings"
  ],
  "AllowedEventTypes": [
    "strings"
  ]
}
```

|Property|Description|
|-|-|
|Name|The unique name of the event dispatcher that triggered the event.|
|OldName|Old filename name of the file prior to a rename. This value is only provided on the `Local.FileSystem.Renamed` event.|
|OldName|Old path name of the file's path prior to a rename. This value is only provided on the `Local.FileSystem.Renamed` event.|
|Filename|Name of the file.|
|DirectoryName|Full directory name of the file.|
|FullFilePath|The full file path including DirectoryName + Filename.|
|ContentLenght|The size of the file in bytes.|
|CorrelationId|Id used to correlate other associated events in the logs.|
|PathToWatch, IncludeSubDirectories, Filters and AllowedEventTypes|These are values passed down from the event dispatcher that is executing the `ExecuteScript` action [See Event Dispatchers](#event-dispatchers) for property details.|
